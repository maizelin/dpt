<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diabetes CDS - ADA 2025</title>
  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { 
      font-family: 'Microsoft JhengHei', Arial, sans-serif; 
      background: #f0f4f8; margin: 0; padding: 20px; 
    }
    .container { max-width: 1100px; margin: auto; }
    h1 { text-align: center; color: #2c3e50; }
    .status-bar { 
      text-align: center; background: #e8f6f3; padding: 8px; 
      border-radius: 4px; color: #16a085; margin-bottom: 20px; 
      display: none; 
    }
    .patient-selector { 
      display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
      gap: 15px; margin-bottom: 40px; 
    }
    .patient-card { 
      background: white; border-radius: 12px; padding: 20px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.1); cursor: pointer; 
      transition: 0.3s; 
    }
    .patient-card:hover { 
      transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); 
    }
    .patient-card h3 { margin: 0 0 10px 0; color: #3498db; }
    .patient-card p { margin: 5px 0; color: #555; }
    .content { 
      display: none; background: white; border-radius: 12px; 
      padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
      position: relative; 
    }
    .back-btn { 
      position: absolute; top: 20px; left: 20px; background: #3498db; 
      color: white; border: none; padding: 8px 16px; border-radius: 8px; 
      cursor: pointer; transition: 0.3s; 
    }
    .back-btn:hover { background: #2980b9; }
    canvas { max-height: 350px; width: 100%; }
    .indicators { 
      display: flex; justify-content: space-around; flex-wrap: wrap; 
      gap: 20px; margin: 30px 0; 
    }
    .indicator-box { text-align: center; min-width: 120px; }
    .bar { 
      height: 40px; border-radius: 8px; line-height: 40px; 
      color: white; font-weight: bold; font-size: 1.2em; 
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3); margin-top: 5px; 
    }
    .green { background: #27ae60; }
    .yellow { background: #f39c12; }
    .red { background: #e74c3c; }
    .recommendations { margin-top: 30px; }
    .rec-item { 
      background: #f8f9fa; padding: 15px; border-left: 5px solid #3498db; 
      margin: 10px 0; border-radius: 6px; 
    }
    .rec-high { border-left-color: #e74c3c; background: #fdf2f2; }
    .rec-good { border-left-color: #27ae60; background: #f0fff4; }
    footer { text-align: center; margin-top: 50px; color: #95a5a6; font-size: 0.9em; }
    .fhir-loading { text-align: center; color: #3498db; font-style: italic; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ©¸ Diabetes CDS - ADA 2025</h1>
    <p style="text-align:center; color:#7f8c8d;">å°ç£ç³–å°¿ç—…ç®¡ç†è¼”åŠ©å·¥å…·</p>
    
    <div id="smartStatus" class="status-bar"></div>
    
    <h2 id="selectorTitle">é¸æ“‡æ¸¬è©¦å€‹æ¡ˆ</h2>
    <div class="patient-selector" id="patientSelector"></div>
    
    <div class="content" id="patientContent">
      <button class="back-btn" id="backBtn" onclick="backToSelector()">â† è¿”å›</button>
      
      <h2 id="patientName" style="margin-left:40px; margin-top: 0;"></h2>
      <p id="patientInfo" style="margin-left:40px;"></p>
      
      <h3 style="margin-left:40px;">HbA1c è¶¨å‹¢åœ–</h3>
      <canvas id="hba1cChart"></canvas>
      
      <h3 style="margin-left:40px;">é¢¨éšªæŒ‡æ¨™</h3>
      <div class="indicators" id="indicators"></div>
      
      <h3 style="margin-left:40px;">CDS å»ºè­° (ADA 2025)</h3>
      <div class="recommendations" id="recommendations"></div>
    </div>
    
    <footer>THAS FHIR Sandbox å„ªåŒ–ç‰ˆ 2025-12-28</footer>
  </div>

  <script>
    let myChart = null;
    let fhirClient = null;
    
    // LOINC Code å°ç…§è¡¨
    const LOINC_CODES = {
      hba1c: '4548-4',  // HbA1c %
      egfr: '48642-3',  // eGFR
      bmi: '59574-4'    // BMI
    };

    // Demo ç—…äººï¼ˆFHIR ç„¡è³‡æ–™æ™‚ fallbackï¼‰
    const testPatients = [
      { id: '683785', name: 'æå¤§è¯', gender: 'ç”·', age: 45, scenario: 'HbA1c ç•¥é«˜', 
        target: 7.0, latestHba1c: 7.1, egfr: 90, bmi: 27, hba1cSeries: [9.5,9.3,9.0,8.8,8.5,8.3,8.1,8.0,7.9,7.8,7.7,7.6,7.5,7.4,7.3,7.3,7.2,7.2,7.1,7.1,7.1,7.1,7.1,7.1,7.1] },
      { id: '683813', name: 'é™³ç¾ç²', gender: 'å¥³', age: 62, scenario: 'CKD 3', target: 7.5, 
        latestHba1c: 7.6, egfr: 45, bmi: 26, hba1cSeries: [8.5,8.4,8.3,8.2,8.1,8.0,7.9,7.9,7.8,7.8,7.7,7.7,7.7,7.7,7.6,7.6,7.6,7.6,7.6,7.6,7.6,7.6,7.6,7.6,7.6] },
      { id: '683847', name: 'å¼µé˜¿å¬¤', gender: 'å¥³', age: 65, scenario: 'é•·è€…', target: 8.0, 
        latestHba1c: 7.5, egfr: 55, bmi: 22, hba1cSeries: [7.8,7.7,7.6,7.7,7.5,7.6,7.8,7.7,7.6,7.5,7.6,7.7,7.5,7.6,7.4,7.5,7.6,7.7,7.6,7.5,7.6,7.7,7.5,7.6,7.5] }
    ];

    // 1. SMART åˆå§‹åŒ– + FHIR è³‡æ–™è¼‰å…¥
    window.onload = function() {
      renderSelector(); // å…ˆé¡¯ç¤º demo å¡ç‰‡
      
      FHIR.oauth2.ready()
        .then(client => {
          fhirClient = client;
          const statusDiv = document.getElementById('smartStatus');
          statusDiv.style.display = 'block';
          
          // é¡¯ç¤º SMART Context
          statusDiv.innerHTML = `âœ… SMART Context å°±ç·’<br>Patient ID: ${client.patient?.id || 'Unknown'}<br>FHIR Server: ${client.server.url}`;
          
          // å¦‚æœ EHR å‚³å…¥ç—…äººï¼Œç›´æ¥è¼‰å…¥
          if (client.patient?.id) {
            loadPatientFromFHIR(client.patient.id);
            document.getElementById('backBtn').style.display = 'none';
          }
        })
        .catch(error => {
          console.log('SMART åˆå§‹åŒ–å¤±æ•—ï¼Œä½¿ç”¨ Demo æ¨¡å¼', error);
          document.getElementById('smartStatus').innerHTML = 'ğŸ’¡ Demo æ¨¡å¼ï¼ˆç„¡ SMART Contextï¼‰';
        });
    };

    // 2. å¾ FHIR è¼‰å…¥çœŸå¯¦ç—…äººè³‡æ–™
    async function loadPatientFromFHIR(patientId) {
      try {
        document.getElementById('smartStatus').innerHTML += '<br>ğŸ”„ å¾ FHIR è¼‰å…¥è³‡æ–™...';
        
        // è®€ Patient åŸºæœ¬è³‡æ–™
        const patient = await fhirClient.request(`Patient/${patientId}`);
        const patientName = patient.name?.[0]?.text || 
                           `${patient.name?.[0]?.family || ''} ${patient.name?.[0]?.given?.join('') || ''}`.trim();
        
        // è®€ HbA1c æ™‚é–“åºåˆ—ï¼ˆæœ€è¿‘ 24 ç­†ï¼‰
        const hba1cObs = await fhirClient.request(
          `Observation?patient=${patientId}&code=${LOINC_CODES.hba1c}&_sort=date&_count=24`
        );
        
        // è®€ eGFR
        const egfrObs = await fhirClient.request(
          `Observation?patient=${patientId}&code=${LOINC_CODES.egfr}&_sort=-date&_count=1`
        );
        
        // è¨ˆç®—å¹´é½¡
        const birthDate = patient.birthDate;
        const age = birthDate ? Math.floor((new Date() - new Date(birthDate)) / (365.25 * 24 * 60 * 60 * 1000)) : '?';
        
        // å»ºæ§‹ FHIR ç—…äººç‰©ä»¶
        const fhirPatient = {
          id: patientId,
          name: patientName || 'æœªçŸ¥',
          gender: patient.gender === 'male' ? 'ç”·' : patient.gender === 'female' ? 'å¥³' : '?',
          age: age,
          scenario: 'FHIR çœŸå¯¦ç—…äºº',
          target: 7.0, // é è¨­ ADA ç›®æ¨™
          latestHba1c: hba1cObs.entry?.[0]?.resource?.valueQuantity?.value || 7.5,
          egfr: egfrObs.entry?.[0]?.resource?.valueQuantity?.value || 90,
          bmi: 25, // æš«ç„¡ BMIï¼Œé è¨­å€¼
          hba1cSeries: hba1cObs.entry?.map(e => e.resource.valueQuantity?.value || 7.5).slice(0, 24) || [7.5]
        };
        
        loadPatient(fhirPatient);
        document.getElementById('smartStatus').innerHTML += '<br>âœ… FHIR è³‡æ–™è¼‰å…¥å®Œæˆ';
        
      } catch (error) {
        console.error('FHIR è¼‰å…¥å¤±æ•—:', error);
        document.getElementById('smartStatus').innerHTML += '<br>âš ï¸ FHIR ç„¡è³‡æ–™ï¼Œä½¿ç”¨ Demo';
      }
    }

    // 3. Demo å¡ç‰‡æ¸²æŸ“
    function renderSelector() {
      const container = document.getElementById('patientSelector');
      container.innerHTML = testPatients.map(p => `
        <div class="patient-card" onclick="loadPatientById('${p.id}')">
          <h3>${p.name}</h3>
          <p>${p.gender}ï¼Œ${p.age}æ­²</p>
          <p><strong>${p.scenario}</strong></p>
          <p>HbA1c ${p.latestHba1c}% (ç›®æ¨™ ${p.target}%)</p>
          <p>ID: ${p.id}</p>
        </div>
      `).join('');
    }

    // 4. è¼‰å…¥ç—…äºº UI
    function loadPatientById(id) {
      const p = testPatients.find(item => item.id == id);
      if (p) loadPatient(p);
    }

    function loadPatient(p) {
      // UI åˆ‡æ›
      document.getElementById('patientSelector').style.display = 'none';
      document.getElementById('selectorTitle').style.display = 'none';
      document.getElementById('patientContent').style.display = 'block';
      
      document.getElementById('patientName').innerText = `${p.name} ${p.gender}ï¼Œ${p.age}æ­²`;
      document.getElementById('patientInfo').innerHTML = `
        ID: ${p.id}<br>
        BMI: ${p.bmi} | eGFR: ${p.egfr} ml/min | <strong>${p.scenario}</strong>
      `;
      
      renderChart(p.hba1cSeries, p.target);
      renderIndicators(p);
      renderRecommendations(p);
    }

    function backToSelector() {
      document.getElementById('patientContent').style.display = 'none';
      document.getElementById('patientSelector').style.display = 'grid';
      document.getElementById('selectorTitle').style.display = 'block';
    }

    // 5. Chart.js è¶¨å‹¢åœ–
    function renderChart(data, target) {
      const ctx = document.getElementById('hba1cChart').getContext('2d');
      if (myChart) myChart.destroy();
      
      const labels = Array.from({length: Math.max(24, data.length)}, (_, i) => `M-${24-i}`);
      
      myChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'HbA1c %',
            data: data,
            borderColor: '#3498db',
            backgroundColor: 'rgba(52, 152, 219, 0.1)',
            tension: 0.4,
            fill: true
          }, {
            label: `ç›®æ¨™ ${target}%`,
            data: Array(Math.max(25, data.length)).fill(target),
            borderColor: '#e74c3c',
            borderDash: [5, 5],
            pointRadius: 0,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { min: 5, max: 12 }
          },
          plugins: {
            title: {
              display: true,
              text: 'HbA1c è¶¨å‹¢ (24å€‹æœˆ)'
            }
          }
        }
      });
    }

    // 6. é¡è‰²è­¦ç¤ºæŒ‡æ¨™
    function renderIndicators(p) {
      const getColor = (val, target, type) => {
        if (type === 'hba1c') {
          return val > target ? 'red' : val > target - 0.5 ? 'yellow' : 'green';
        }
        if (type === 'egfr') {
          return val > 60 ? 'green' : val > 30 ? 'yellow' : 'red';
        }
        if (type === 'bmi') {
          return val < 24 ? 'green' : val < 27 ? 'yellow' : 'red';
        }
        return 'green';
      };

      const html = `
        <div class="indicator-box">
          <div>HbA1c</div>
          <div class="bar ${getColor(p.latestHba1c, p.target, 'hba1c')}">${p.latestHba1c}%</div>
          <small>ç›®æ¨™ ${p.target}%</small>
        </div>
        <div class="indicator-box">
          <div>eGFR</div>
          <div class="bar ${getColor(p.egfr, 0, 'egfr')}">${p.egfr}</div>
          <small>ml/min</small>
        </div>
        <div class="indicator-box">
          <div>BMI</div>
          <div class="bar ${getColor(p.bmi, 0, 'bmi')}">${p.bmi}</div>
          <small>kg/mÂ²</small>
        </div>
      `;
      document.getElementById('indicators').innerHTML = html;
    }

    // 7. ADA 2025 CDS å»ºè­°
    function renderRecommendations(p) {
      let recs = [];
      
      // 1. HbA1c æ§åˆ¶
      if (p.latestHba1c > p.target) {
        recs.push(`
          <div class="rec-item rec-high">
            <strong>âš ï¸ HbA1c ${p.latestHba1c}% è¶…éç›®æ¨™ ${p.target}%</strong><br>
            å»ºè­°åŠ å¼·è¡€ç³–æ§åˆ¶ï¼Œè©•ä¼°é™ç³–è—¥èª¿æ•´
          </div>
        `);
      } else {
        recs.push(`
          <div class="rec-item rec-good">
            <strong>âœ… HbA1c ${p.latestHba1c}% å·²é”ç›®æ¨™</strong><br>
            æŒçºŒç¶­æŒä¸¦å®šæœŸè¿½è¹¤
          </div>
        `);
      }
      
      // 2. ADA SGLT2i å»ºè­° (eGFR > 30)
      if (p.egfr > 30) {
        recs.push(`
          <div class="rec-item">
            <strong>ğŸ’Š ADA å»ºè­° SGLT2i</strong><br>
            eGFR ${p.egfr} > 30ï¼Œé©åˆå¿ƒè…ä¿è­·ï¼ˆå¿ƒè¡°/CKDï¼‰
          </div>
        `);
      }
      
      // 3. ADA GLP-1 RA å»ºè­° (BMI > 27)
      if (p.bmi > 27) {
        recs.push(`
          <div class="rec-item">
            <strong>ğŸ’‰ ADA å»ºè­° GLP-1 RA</strong><br>
            BMI ${p.bmi} > 27ï¼Œé©åˆæ¸›é‡+å¿ƒè¡€ç®¡ä¿è­·
          </div>
        `);
      }
      
      document.getElementById('recommendations').innerHTML = recs.join('');
    }
  </script>
</body>
</html>
